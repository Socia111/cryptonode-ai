<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AItradeX1 Smoke Tests</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; }
        .pass { background: #1a4d1a; border-color: #0f0; }
        .fail { background: #4d1a1a; border-color: #f00; }
        .pending { background: #4d4d1a; border-color: #ff0; }
        pre { overflow-x: auto; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; background: #333; color: #fff; border: 1px solid #666; cursor: pointer; }
        button:hover { background: #555; }
        .header { font-size: 24px; margin-bottom: 20px; color: #0ff; }
    </style>
</head>
<body>
    <div class="header">üöÄ AItradeX1 Smoke Tests</div>
    
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
    <button onclick="testWebSocket()">Test Bybit WebSocket</button>
    
    <div id="results"></div>

    <script>
        const PROJECT_ID = 'codhlwjogfjywmjyjbbn';
        const BASE_URL = `https://${PROJECT_ID}.supabase.co/functions/v1`;
        
        let testResults = [];

        async function runTest(name, testFn) {
            const testDiv = document.createElement('div');
            testDiv.className = 'test pending';
            testDiv.innerHTML = `<h3>${name}</h3><pre>Running...</pre>`;
            document.getElementById('results').appendChild(testDiv);

            try {
                const result = await testFn();
                testDiv.className = 'test pass';
                testDiv.innerHTML = `<h3>‚úÖ ${name}</h3><pre>${JSON.stringify(result, null, 2)}</pre>`;
                testResults.push({ name, status: 'pass', result });
            } catch (error) {
                testDiv.className = 'test fail';
                testDiv.innerHTML = `<h3>‚ùå ${name}</h3><pre>Error: ${error.message}</pre>`;
                testResults.push({ name, status: 'fail', error: error.message });
            }
        }

        // Test 0: Basic function availability
        async function testFunctionPing() {
            const responses = await Promise.allSettled([
                fetch(`${BASE_URL}/bybit-broker/ping`).then(r => r.json()),
                fetch(`${BASE_URL}/automated-trading-engine/ping`).then(r => r.json())
            ]);
            
            return {
                bybitBroker: responses[0].status === 'fulfilled' ? responses[0].value : responses[0].reason,
                tradingEngine: responses[1].status === 'fulfilled' ? responses[1].value : responses[1].reason
            };
        }

        // Test 1: Secrets visibility (masked)
        async function testSecretsVisibility() {
            const response = await fetch(`${BASE_URL}/bybit-broker/env`);
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return await response.json();
        }

        // Test 2: Live Bybit connection
        async function testBybitConnection() {
            const response = await fetch(`${BASE_URL}/bybit-broker/test-connection`);
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return await response.json();
        }

        // Test 3: Trading engine status
        async function testTradingEngineStatus() {
            const response = await fetch(`${BASE_URL}/automated-trading-engine`, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ action: 'status' })
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return await response.json();
        }

        // Test 4: Signal generation
        async function testSignalGeneration() {
            const response = await fetch(`${BASE_URL}/live-scanner-production`, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ 
                    exchange: 'bybit',
                    timeframe: '5m',
                    relaxed_filters: true,
                    symbols: ['BTCUSDT', 'ETHUSDT'] 
                })
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return await response.json();
        }

        // Test 5: Database connectivity
        async function testDatabaseAccess() {
            const response = await fetch(`https://${PROJECT_ID}.supabase.co/rest/v1/signals?select=count`, {
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvZGhsd2pvZ2ZqeXdtanlqYmJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTA3NjgsImV4cCI6MjA2OTA4Njc2OH0.Rjfe5evX0JZ2O-D3em4Sm1FtwIRtfPZWhm0zAJvg-H0',
                    'prefer': 'count=exact'
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            const count = response.headers.get('content-range');
            return { signalsCount: count, status: 'connected' };
        }

        // WebSocket test for Bybit
        function testWebSocket() {
            const testDiv = document.createElement('div');
            testDiv.className = 'test pending';
            testDiv.innerHTML = `<h3>WebSocket Test</h3><pre>Connecting to Bybit WebSocket...</pre>`;
            document.getElementById('results').appendChild(testDiv);

            const ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
            const messages = [];
            let connected = false;

            const timeout = setTimeout(() => {
                if (!connected) {
                    ws.close();
                    testDiv.className = 'test fail';
                    testDiv.innerHTML = `<h3>‚ùå WebSocket Test</h3><pre>Timeout: No connection within 10 seconds</pre>`;
                }
            }, 10000);

            ws.onopen = () => {
                connected = true;
                testDiv.innerHTML = `<h3>WebSocket Test</h3><pre>Connected! Subscribing to BTCUSDT...</pre>`;
                ws.send(JSON.stringify({ 
                    op: 'subscribe', 
                    args: ['publicTrade.BTCUSDT', 'orderbook.1.BTCUSDT'] 
                }));
            };

            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                messages.push(data);
                
                if (messages.length >= 3) {
                    clearTimeout(timeout);
                    ws.close();
                    testDiv.className = 'test pass';
                    testDiv.innerHTML = `<h3>‚úÖ WebSocket Test</h3><pre>Received ${messages.length} messages:\n${JSON.stringify(messages.slice(0, 2), null, 2)}</pre>`;
                }
            };

            ws.onerror = (error) => {
                clearTimeout(timeout);
                testDiv.className = 'test fail';
                testDiv.innerHTML = `<h3>‚ùå WebSocket Test</h3><pre>WebSocket error: ${error}</pre>`;
            };
        }

        async function runAllTests() {
            testResults = [];
            document.getElementById('results').innerHTML = '';
            
            console.log('üöÄ Starting AItradeX1 smoke tests...');
            
            await runTest('0. Function Ping Test', testFunctionPing);
            await runTest('1. Secrets Visibility', testSecretsVisibility);
            await runTest('2. Bybit Connection', testBybitConnection);
            await runTest('3. Trading Engine Status', testTradingEngineStatus);
            await runTest('4. Signal Generation', testSignalGeneration);
            await runTest('5. Database Access', testDatabaseAccess);
            
            // Summary
            const passed = testResults.filter(t => t.status === 'pass').length;
            const failed = testResults.filter(t => t.status === 'fail').length;
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = failed === 0 ? 'test pass' : 'test fail';
            summaryDiv.innerHTML = `<h3>üìä Summary</h3><pre>Passed: ${passed}/${testResults.length}\nFailed: ${failed}</pre>`;
            document.getElementById('results').appendChild(summaryDiv);
            
            console.log(`‚úÖ Tests complete: ${passed}/${testResults.length} passed`);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
        }

        // Auto-run tests when page loads
        window.onload = () => {
            console.log('AItradeX1 Smoke Test Suite loaded');
            console.log('Click "Run All Tests" to start, or individual test buttons');
        };
    </script>
</body>
</html>