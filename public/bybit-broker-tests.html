<!doctype html>
<meta charset="utf-8" />
<title>Bybit Broker ‚Äì Smoke Tests</title>
<style>
  body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; background: #f8fafc; }
  .container { max-width: 1200px; margin: 0 auto; }
  .row { display:flex; gap:8px; flex-wrap:wrap; margin: 12px 0; }
  button { padding:10px 14px; border:0; border-radius:10px; background:#111827; color:#fff; cursor:pointer; font-size: 13px; }
  button:hover { background:#374151; }
  button:disabled { background:#9ca3af; cursor: not-allowed; }
  input { width: 520px; padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px; }
  pre { background:#0b1020; color:#c7d2fe; padding:14px; border-radius:12px; max-height:60vh; overflow:auto; font-size: 12px; line-height: 1.4; }
  small { color:#6b7280; }
  .status { padding: 8px 12px; border-radius: 6px; margin: 8px 0; }
  .status.success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
  .status.error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
  .status.warning { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
  h1 { color: #111827; margin-bottom: 8px; }
  h2 { color: #374151; font-size: 18px; margin: 24px 0 12px 0; }
  .test-section { background: white; padding: 20px; border-radius: 12px; margin: 16px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
</style>

<div class="container">
  <h1>üöÄ Bybit Broker ‚Äì Smoke Tests</h1>
  
  <div class="test-section">
    <h2>Configuration</h2>
    <div class="row">
      <input id="base" value="https://codhlwjogfjywmjyjbbn.supabase.co/functions/v1/bybit-broker" placeholder="Bybit Broker URL" />
    </div>
    <small>Update the URL above to match your Supabase project ID</small>
  </div>

  <div class="test-section">
    <h2>Core Tests</h2>
    <div class="row">
      <button onclick="opt()" title="Test CORS preflight">0) OPTIONS</button>
      <button onclick="get('/ping')" title="Basic health check">1) /ping</button>
      <button onclick="get('/env')" title="Check environment variables">2) /env</button>
      <button onclick="get('/test-connection')" title="Test Bybit API connection">3) /test-connection</button>
      <button onclick="get('/test-connection?debug=1')" title="Debug signature generation">3b) /test-connection?debug=1</button>
      <button onclick="post('', { action:'status' })" title="Get account status">4) account status</button>
    </div>
    <small>Expected: OPTIONS=204; /ping ‚Üí {"ok":true}; /env shows masked keys; /test-connection succeeds; status returns balances.</small>
  </div>

  <div class="test-section">
    <h2>Market Data Tests</h2>
    <div class="row">
      <button onclick="get('/tickers?category=linear&symbol=BTCUSDT')" title="Get BTC ticker">BTCUSDT Ticker</button>
      <button onclick="get('/tickers?category=linear')" title="Get all linear tickers">All Linear Tickers</button>
      <button onclick="fetchBybitServerTime()" title="Check server time and drift">Bybit Server Time</button>
    </div>
  </div>

  <div class="test-section">
    <h2>Account Tests</h2>
    <div class="row">
      <button onclick="get('/positions?category=linear')" title="Get linear positions">Linear Positions</button>
      <button onclick="get('/orders?category=linear&openOnly=1')" title="Get open orders">Open Orders</button>
      <button onclick="get('/orders?category=linear&symbol=BTCUSDT')" title="Get BTCUSDT orders">BTCUSDT Orders</button>
    </div>
  </div>

  <div class="test-section">
    <h2>Trading Tests (‚ö†Ô∏è USE WITH CAUTION)</h2>
    <div class="row">
      <button onclick="confirmAndExecute('testOrder')" style="background: #dc2626;" title="Place a small test order">‚ö†Ô∏è Test Order (0.001 BTC)</button>
      <button onclick="confirmAndExecute('cancelLastOrder')" style="background: #ea580c;" title="Cancel most recent order">‚ö†Ô∏è Cancel Last Order</button>
    </div>
    <small style="color: #dc2626;">‚ö†Ô∏è WARNING: These buttons place real orders with real money! Only use on testnet or with tiny amounts!</small>
  </div>

  <div id="status" class="status" style="display: none;"></div>
  <pre id="out">Ready. Click any test button above to see results.</pre>
</div>

<script>
const out = document.getElementById('out');
const status = document.getElementById('status');
const base = () => document.getElementById('base').value.replace(/\/$/, '');

function showStatus(message, type = 'success') {
  status.style.display = 'block';
  status.className = `status ${type}`;
  status.textContent = message;
  setTimeout(() => status.style.display = 'none', 5000);
}

function show(label, res, body, extra) {
  const headers = {}; 
  res.headers.forEach((v,k) => headers[k] = v);
  
  const timestamp = new Date().toISOString();
  const responseInfo = {
    timestamp,
    url: res.url,
    status: res.status,
    statusText: res.statusText,
    headers,
    body,
    ...extra
  };
  
  out.textContent = `${label}\n\n${JSON.stringify(responseInfo, null, 2)}`;
  
  // Show status indicator
  if (res.ok && !body?.error) {
    showStatus(`‚úÖ ${label} - Success`, 'success');
  } else {
    showStatus(`‚ùå ${label} - Failed (${res.status})`, 'error');
  }
}

async function opt() {
  const res = await fetch(base(), { method: 'OPTIONS' });
  const txt = await res.text().catch(() => '');
  show('OPTIONS ' + base(), res, txt);
}

async function get(path) {
  try {
    const url = base() + path;
    const res = await fetch(url);
    let body; 
    try { 
      body = await res.json(); 
    } catch { 
      body = await res.text(); 
    }
    show('GET ' + path, res, body);
  } catch (error) {
    showStatus(`‚ùå GET ${path} - Network Error: ${error.message}`, 'error');
    out.textContent = `Network Error: ${error.message}`;
  }
}

async function post(path, payload) {
  try {
    const url = base() + path;
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload || {})
    });
    let body; 
    try { 
      body = await res.json(); 
    } catch { 
      body = await res.text(); 
    }
    show('POST ' + path, res, body);
  } catch (error) {
    showStatus(`‚ùå POST ${path} - Network Error: ${error.message}`, 'error');
    out.textContent = `Network Error: ${error.message}`;
  }
}

async function fetchBybitServerTime() {
  try {
    const url = 'https://api.bybit.com/v5/market/time';
    const res = await fetch(url);
    const body = await res.json().catch(() => ({}));
    const now = Date.now();
    const serverMs = Number(body?.result?.timeSecond) * 1000 || Number(body?.time) || 0;
    const driftMs = serverMs ? now - serverMs : null;
    const driftWarning = Math.abs(driftMs) > 1000 ? '‚ö†Ô∏è HIGH DRIFT' : '‚úÖ Normal drift';
    
    show('Bybit Server Time Check', res, body, { 
      localTimeMs: now,
      serverMs,
      driftMs,
      driftWarning,
      recommendation: Math.abs(driftMs) > 5000 ? 'Consider increasing BYBIT_RECV_WINDOW to 10000' : 'Drift is acceptable'
    });
  } catch (error) {
    showStatus(`‚ùå Server Time Check Failed: ${error.message}`, 'error');
  }
}

function confirmAndExecute(action) {
  const confirmMsg = action === 'testOrder' 
    ? 'This will place a REAL order for 0.001 BTC (~$50-100). Continue only if using testnet or you understand the risks!'
    : 'This will cancel your most recent order. Are you sure?';
    
  if (!confirm(confirmMsg)) return;
  
  if (action === 'testOrder') {
    testOrder();
  } else if (action === 'cancelLastOrder') {
    cancelLastOrder();
  }
}

async function testOrder() {
  const orderData = {
    category: 'linear',
    symbol: 'BTCUSDT',
    side: 'Buy',
    orderType: 'Market',
    qty: '0.001',
    positionIdx: 0
  };
  
  await post('/order', orderData);
}

async function cancelLastOrder() {
  try {
    // First get recent orders
    const ordersRes = await fetch(base() + '/orders?category=linear&openOnly=1');
    const ordersData = await ordersRes.json();
    
    if (ordersData.orders && ordersData.orders.length > 0) {
      const lastOrder = ordersData.orders[0];
      await post('/cancel', {
        category: 'linear',
        symbol: lastOrder.symbol,
        orderId: lastOrder.orderId
      });
    } else {
      showStatus('No open orders to cancel', 'warning');
    }
  } catch (error) {
    showStatus(`‚ùå Cancel failed: ${error.message}`, 'error');
  }
}

// Auto-detect project ID and update URL
document.addEventListener('DOMContentLoaded', () => {
  const hostname = window.location.hostname;
  if (hostname.includes('lovable.app')) {
    // Extract project ID from lovable URL if available
    const projectMatch = hostname.match(/^([a-zA-Z0-9-]+)\.lovable\.app$/);
    if (projectMatch) {
      showStatus('üí° Detected Lovable environment. Make sure to update the Supabase project ID in the URL above.', 'warning');
    }
  }
});
</script>